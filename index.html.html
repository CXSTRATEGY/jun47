<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카드 소팅 리서치 툴</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .mode-selector {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .mode-btn {
            flex: 1;
            padding: 25px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
            margin-bottom: -3px;
        }

        .mode-btn:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        /* 연구자 모드 스타일 */
        .researcher-mode {
            display: none;
        }

        .researcher-mode.active {
            display: block;
        }

        .setup-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: #f8f9fa;
        }

        .setup-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
        }

        .items-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .item-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .item-tag .remove-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .url-generator {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .url-display {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #2196f3;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }

        /* 참여자 모드 스타일 */
        .participant-mode {
            display: none;
        }

        .participant-mode.active {
            display: block;
        }

        .study-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .study-info h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .participant-input {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .sorting-area {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 30px;
            height: 70vh;
        }

        .groups-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 3px dashed #dee2e6;
        }

        .groups-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .group-box {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            min-height: 120px;
            transition: all 0.3s ease;
        }

        .group-box.drag-over {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: scale(1.02);
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .group-name {
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        .group-name.editable {
            background: none;
            border: none;
            outline: none;
            border-bottom: 2px solid #4facfe;
            padding: 2px 5px;
        }

        .add-group-btn {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-group-btn:hover {
            transform: translateY(-2px);
        }

        .group-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .cards-container {
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            border: 3px dashed #ffc107;
        }

        .cards-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #856404;
            margin-bottom: 20px;
            text-align: center;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .card-item {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: grab;
            user-select: none;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .card-item:active {
            cursor: grabbing;
        }

        .card-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .card-item.in-group {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            font-size: 0.9em;
            padding: 8px 12px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .completion-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
        }

        .modal-content h3 {
            color: #28a745;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .result-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #dc3545;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .mode-btn {
                padding: 15px 10px;
                font-size: 1em;
            }

            .content {
                padding: 20px;
            }

            .sorting-area {
                height: auto;
            }

            .groups-grid {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧩 카드 소팅 리서치 툴</h1>
            <p>연구자와 참여자 모두를 위한 전문 카드 소팅 도구</p>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('researcher')">👨‍🔬 연구자 모드</button>
            <button class="mode-btn" onclick="switchMode('participant')">👥 참여자 모드</button>
        </div>

        <!-- 연구자 모드 -->
        <div id="researcher-mode" class="content researcher-mode active">
            <div class="setup-section">
                <h3>📋 연구 기본 정보</h3>
                <div class="input-group">
                    <input type="text" id="study-title" placeholder="연구 제목을 입력하세요" value="쇼핑몰 카테고리 구조 최적화 연구">
                </div>
                <div class="input-group">
                    <input type="text" id="study-description" placeholder="연구 설명을 입력하세요" value="사용자가 인식하는 상품 카테고리 분류 방식을 알아보는 연구입니다.">
                </div>
            </div>

            <div class="setup-section">
                <h3>🎴 카드 설정 (최대 100개)</h3>
                <div class="input-group">
                    <input type="text" id="card-input" placeholder="카드 내용을 입력하세요" maxlength="50">
                    <button class="btn btn-primary" onclick="addCard()">카드 추가</button>
                </div>
                <div class="items-list" id="cards-list"></div>
            </div>

            <div class="setup-section">
                <h3>📁 기본 그룹 설정 (최대 30개) - 선택사항</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">오픈 카드소팅의 경우 비워두세요. 참여자가 직접 그룹을 만들 수 있습니다.</p>
                <div class="input-group">
                    <input type="text" id="group-input" placeholder="그룹명을 입력하세요" maxlength="30">
                    <button class="btn btn-primary" onclick="addGroup()">그룹 추가</button>
                </div>
                <div class="items-list" id="groups-list"></div>
            </div>

            <div class="setup-section">
                <h3>🌐 배포 URL 설정</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">Netlify 배포 후 실제 도메인을 입력하세요 (예: https://my-card-sorting.netlify.app)</p>
                <div class="input-group">
                    <input type="text" id="base-url" placeholder="https://your-site.netlify.app" value="https://your-site.netlify.app">
                    <button class="btn btn-primary" onclick="updateBaseURL()">URL 저장</button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success btn-large" onclick="generateStudyURL()">🔗 참여자 URL 생성</button>
                <button class="btn btn-primary btn-large" onclick="downloadHTMLFile()">💾 HTML 파일 다운로드</button>
                <button class="btn btn-danger btn-large" onclick="resetAll()">🔄 전체 초기화</button>
            </div>

            <div class="url-generator" id="url-generator" style="display: none;">
                <h4>📤 참여자 공유 URL</h4>
                <p>아래 URL을 참여자들에게 공유하세요:</p>
                <div class="url-display" id="study-url"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="copyURL()">📋 URL 복사</button>
                    <button class="btn btn-success" onclick="testParticipantMode()">👤 참여자 화면 테스트</button>
                </div>
            </div>
        </div>

        <!-- 참여자 모드 -->
        <div id="participant-mode" class="content participant-mode">
            <div class="study-info">
                <h3 id="display-study-title">카드 소팅 연구에 참여해주셔서 감사합니다</h3>
                <p id="display-study-description">아래 설명을 읽고 카드를 분류해주세요.</p>
            </div>

            <div class="participant-input">
                <h4>👤 참여자 정보</h4>
                <div class="input-group">
                    <input type="text" id="participant-name" placeholder="이름 또는 참여자 ID를 입력하세요">
                    <button class="btn btn-primary" onclick="startSorting()">시작하기</button>
                </div>
            </div>

            <div id="sorting-interface" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <p style="text-align: center; margin-bottom: 20px;">
                    진행률: <span id="progress-text">0%</span> 
                    (<span id="assigned-count">0</span>/<span id="total-count">0</span> 카드 분류 완료)
                </p>

                <div class="sorting-area">
                    <div class="groups-container">
                        <div class="groups-title">📁 그룹 영역 (카드를 여기로 드래그하세요)</div>
                        <div class="groups-grid" id="groups-grid"></div>
                    </div>

                    <div class="cards-container">
                        <div class="cards-title">🎴 카드 목록</div>
                        <div class="cards-grid" id="cards-grid"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success btn-large" onclick="submitSorting()">✅ 분류 완료</button>
                    <button class="btn btn-danger btn-large" onclick="resetSorting()">🔄 다시 시작</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 완료 모달 -->
    <div class="completion-modal" id="completion-modal">
        <div class="modal-content">
            <h3>🎉 분류 완료!</h3>
            <p>카드 소팅에 참여해주셔서 감사합니다.</p>
            <div class="result-summary" id="final-summary"></div>
            <div class="action-buttons">
                <button class="btn btn-primary btn-large" onclick="downloadResult()">💾 결과 다운로드</button>
                <button class="btn btn-success btn-large" onclick="emailResult()">📧 이메일 전송</button>
            </div>
            <button class="btn btn-danger" onclick="closeModal()" style="margin-top: 20px;">닫기</button>
        </div>
    </div>

    <script>
        // 전역 변수
        let studyData = {
            title: '',
            description: '',
            cards: [],
            groups: [],
            isOpenSorting: true
        };
        
        let participantData = {
            name: '',
            startTime: null,
            endTime: null,
            sortingResult: {}
        };

        let baseURL = 'https://your-site.netlify.app'; // 기본 URL

        // 초기화
        function init() {
            loadSampleData();
            renderResearcherMode();
        }

        // 샘플 데이터 로드
        function loadSampleData() {
            studyData.cards = ['스마트폰', '노트북', '태블릿', '냉장고', '세탁기', '전자레인지', '블라우스', '청바지', '운동화'];
            studyData.groups = ['전자기기', '가전제품', '의류'];
            studyData.title = '쇼핑몰 카테고리 구조 최적화 연구';
            studyData.description = '사용자가 인식하는 상품 카테고리 분류 방식을 알아보는 연구입니다.';
        }

        // 모드 전환
        function switchMode(mode) {
            // 모든 모드 비활성화
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.researcher-mode, .participant-mode').forEach(content => content.classList.remove('active'));
            
            // 선택된 모드 활성화
            event.target.classList.add('active');
            document.getElementById(mode + '-mode').classList.add('active');

            if (mode === 'researcher') {
                renderResearcherMode();
            } else {
                renderParticipantMode();
            }
        }

        // 연구자 모드 렌더링
        function renderResearcherMode() {
            document.getElementById('study-title').value = studyData.title;
            document.getElementById('study-description').value = studyData.description;
            document.getElementById('base-url').value = baseURL;
            renderCardsList();
            renderGroupsList();
        }

        function renderCardsList() {
            const cardsList = document.getElementById('cards-list');
            cardsList.innerHTML = '';
            studyData.cards.forEach((card, index) => {
                cardsList.innerHTML += `
                    <div class="item-tag">
                        ${card}
                        <button class="remove-btn" onclick="removeCard(${index})">×</button>
                    </div>
                `;
            });
        }

        function renderGroupsList() {
            const groupsList = document.getElementById('groups-list');
            groupsList.innerHTML = '';
            studyData.groups.forEach((group, index) => {
                groupsList.innerHTML += `
                    <div class="item-tag">
                        ${group}
                        <button class="remove-btn" onclick="removeGroup(${index})">×</button>
                    </div>
                `;
            });
        }

        // 카드 추가
        function addCard() {
            const input = document.getElementById('card-input');
            const cardText = input.value.trim();
            
            if (!cardText) {
                showToast('카드 내용을 입력해주세요', 'error');
                return;
            }
            
            if (studyData.cards.length >= 100) {
                showToast('카드는 최대 100개까지 추가할 수 있습니다', 'error');
                return;
            }
            
            if (studyData.cards.includes(cardText)) {
                showToast('이미 존재하는 카드입니다', 'error');
                return;
            }
            
            studyData.cards.push(cardText);
            input.value = '';
            renderCardsList();
            showToast('카드가 추가되었습니다');
        }

        // 그룹 추가
        function addGroup() {
            const input = document.getElementById('group-input');
            const groupText = input.value.trim();
            
            if (!groupText) {
                showToast('그룹명을 입력해주세요', 'error');
                return;
            }
            
            if (studyData.groups.length >= 30) {
                showToast('그룹은 최대 30개까지 추가할 수 있습니다', 'error');
                return;
            }
            
            if (studyData.groups.includes(groupText)) {
                showToast('이미 존재하는 그룹입니다', 'error');
                return;
            }
            
            studyData.groups.push(groupText);
            input.value = '';
            renderGroupsList();
            showToast('그룹이 추가되었습니다');
        }

        // 카드/그룹 제거
        function removeCard(index) {
            studyData.cards.splice(index, 1);
            renderCardsList();
            showToast('카드가 제거되었습니다');
        }

        function removeGroup(index) {
            studyData.groups.splice(index, 1);
            renderGroupsList();
            showToast('그룹이 제거되었습니다');
        }

        // HTML 파일 다운로드
        function downloadHTMLFile() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'card-sorting-tool.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('HTML 파일이 다운로드되었습니다!');
        }

        // 베이스 URL 업데이트
        function updateBaseURL() {
            const urlInput = document.getElementById('base-url').value.trim();
            if (urlInput) {
                baseURL = urlInput.endsWith('/') ? urlInput.slice(0, -1) : urlInput;
                showToast('배포 URL이 저장되었습니다');
            } else {
                showToast('올바른 URL을 입력해주세요', 'error');
            }
        }

        // URL 생성
        function generateStudyURL() {
            if (studyData.cards.length === 0) {
                showToast('최소 1개 이상의 카드를 추가해주세요', 'error');
                return;
            }

            // 연구 정보 업데이트
            studyData.title = document.getElementById('study-title').value.trim() || '카드 소팅 연구';
            studyData.description = document.getElementById('study-description').value.trim() || '카드를 적절한 그룹으로 분류해주세요.';
            studyData.isOpenSorting = studyData.groups.length === 0;

            // URL 매개변수로 데이터 인코딩
            const encodedData = btoa(encodeURIComponent(JSON.stringify(studyData)));
            
            // 실제 배포 URL 사용
            let finalURL = baseURL;
            
            // 현재 환경이 실제 웹사이트인지 확인
            const currentLocation = window.location.href;
            if (!currentLocation.includes('about:srcdoc') && !currentLocation.includes('localhost')) {
                finalURL = currentLocation.split('?')[0];
            }
            
            const studyURL = `${finalURL}?study=${encodedData}`;
            
            document.getElementById('study-url').textContent = studyURL;
            document.getElementById('url-generator').style.display = 'block';
            showToast('참여자 URL이 생성되었습니다!');
        }

        // URL 복사
        function copyURL() {
            const urlText = document.getElementById('study-url').textContent;
            navigator.clipboard.writeText(urlText).then(() => {
                showToast('URL이 클립보드에 복사되었습니다');
            }).catch(() => {
                showToast('복사에 실패했습니다', 'error');
            });
        }

        // 참여자 화면 테스트
        function testParticipantMode() {
            switchMode('participant');
            loadStudyFromURL();
        }

        // 참여자 모드 렌더링
        function renderParticipantMode() {
            // URL에서 연구 데이터 로드
            loadStudyFromURL();
            
            document.getElementById('display-study-title').textContent = studyData.title;
            document.getElementById('display-study-description').textContent = studyData.description;
        }

        // URL에서 연구 데이터 로드
        function loadStudyFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const studyParam = urlParams.get('study');
            
            if (studyParam) {
                try {
                    const decodedData = JSON.parse(decodeURIComponent(atob(studyParam)));
                    studyData = decodedData;
                    document.getElementById('display-study-title').textContent = studyData.title;
                    document.getElementById('display-study-description').textContent = studyData.description;
                } catch (error) {
                    showToast('연구 데이터를 불러오는데 실패했습니다', 'error');
                }
            }
        }

        // 카드 소팅 시작
        function startSorting() {
            const participantName = document.getElementById('participant-name').value.trim();
            
            if (!participantName) {
                showToast('참여자 이름을 입력해주세요', 'error');
                return;
            }

            participantData.name = participantName;
            participantData.startTime = new Date().toISOString();
            participantData.sortingResult = {};

            // 그룹 초기화
            studyData.groups.forEach(group => {
                participantData.sortingResult[group] = [];
            });

            document.getElementById('sorting-interface').style.display = 'block';
            renderSortingInterface();
            updateProgress();
            showToast('카드 소팅을 시작합니다!');
        }

        // 소팅 인터페이스 렌더링
        function renderSortingInterface() {
            renderGroupsGrid();
            renderCardsGrid();
        }

        function renderGroupsGrid() {
            const groupsGrid = document.getElementById('groups-grid');
            groupsGrid.innerHTML = '';
            
            // 기존 그룹들
            studyData.groups.forEach((group, index) => {
                groupsGrid.innerHTML += `
                    <div class="group-box" data-group="${group}" ondragover="allowDrop(event)" ondrop="dropCard(event)">
                        <div class="group-header">
                            <div class="group-name">${group}</div>
                        </div>
                        <div class="group-cards" id="group-${group.replace(/\s+/g, '-')}"></div>
                    </div>
                `;
            });
            
            // 오픈 소팅인 경우 새 그룹 추가 버튼
            if (studyData.isOpenSorting) {
                groupsGrid.innerHTML += `
                    <div class="add-group-btn" onclick="addNewGroup()">
                        ➕ 새 그룹 추가
                    </div>
                `;
            }
        }

        function renderCardsGrid() {
            const cardsGrid = document.getElementById('cards-grid');
            cardsGrid.innerHTML = '';
            
            studyData.cards.forEach((card, index) => {
                const isAssigned = Object.values(participantData.sortingResult).some(groupCards => groupCards.includes(card));
                if (!isAssigned) {
                    cardsGrid.innerHTML += `
                        <div class="card-item" draggable="true" ondragstart="dragStart(event)" data-card="${card}">
                            ${card}
                        </div>
                    `;
                }
            });
        }

        // 드래그 앤 드롭 기능
        function dragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.dataset.card);
            event.target.classList.add('dragging');
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function dropCard(event) {
            event.preventDefault();
            const card = event.dataTransfer.getData('text/plain');
            const groupBox = event.currentTarget;
            const groupName = groupBox.dataset.group;
            
            groupBox.classList.remove('drag-over');
            
            // 카드를 그룹에 추가
            if (!participantData.sortingResult[groupName]) {
                participantData.sortingResult[groupName] = [];
            }
            
            // 다른 그룹에서 카드 제거
            Object.keys(participantData.sortingResult).forEach(group => {
                participantData.sortingResult[group] = participantData.sortingResult[group].filter(c => c !== card);
            });
            
            participantData.sortingResult[groupName].push(card);
            
            // UI 업데이트
            updateGroupDisplay(groupName);
            renderCardsGrid();
            updateProgress();
            
            // 드래그 효과 제거
            document.querySelectorAll('.card-item').forEach(cardEl => {
                cardEl.classList.remove('dragging');
            });
        }

        function updateGroupDisplay(groupName) {
            const groupCardsContainer = document.getElementById(`group-${groupName.replace(/\s+/g, '-')}`);
            if (groupCardsContainer) {
                groupCardsContainer.innerHTML = '';
                participantData.sortingResult[groupName].forEach(card => {
                    groupCardsContainer.innerHTML += `
                        <div class="card-item in-group" onclick="removeFromGroup('${card}', '${groupName}')">
                            ${card}
                        </div>
                    `;
                });
            }
        }

        // 진행률 업데이트
        function updateProgress() {
            const totalCards = studyData.cards.length;
            const assignedCards = Object.values(participantData.sortingResult).reduce((sum, groupCards) => sum + groupCards.length, 0);
            const progress = Math.round((assignedCards / totalCards) * 100);
            
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
            document.getElementById('assigned-count').textContent = assignedCards;
            document.getElementById('total-count').textContent = totalCards;
        }

        // 그룹에서 카드 제거
        function removeFromGroup(card, groupName) {
            participantData.sortingResult[groupName] = participantData.sortingResult[groupName].filter(c => c !== card);
            updateGroupDisplay(groupName);
            renderCardsGrid();
            updateProgress();
        }

        // 새 그룹 추가 (오픈 소팅)
        function addNewGroup() {
            const groupName = prompt('새 그룹명을 입력하세요:');
            if (groupName && groupName.trim()) {
                const trimmedName = groupName.trim();
                if (!Object.keys(participantData.sortingResult).includes(trimmedName)) {
                    participantData.sortingResult[trimmedName] = [];
                    studyData.groups.push(trimmedName);
                    renderGroupsGrid();
                    showToast('새 그룹이 추가되었습니다');
                } else {
                    showToast('이미 존재하는 그룹명입니다', 'error');
                }
            }
        }

        // 소팅 제출
        function submitSorting() {
            const assignedCards = Object.values(participantData.sortingResult).reduce((sum, groupCards) => sum + groupCards.length, 0);
            
            if (assignedCards === 0) {
                showToast('최소 1개 이상의 카드를 분류해주세요', 'error');
                return;
            }

            participantData.endTime = new Date().toISOString();
            
            // 결과 요약
            const totalCards = studyData.cards.length;
            const usedGroups = Object.keys(participantData.sortingResult).filter(group => participantData.sortingResult[group].length > 0).length;
            const unassignedCards = totalCards - assignedCards;
            
            document.getElementById('final-summary').innerHTML = `
                <p><strong>총 카드 수:</strong> ${totalCards}개</p>
                <p><strong>분류 완료:</strong> ${assignedCards}개</p>
                <p><strong>사용된 그룹:</strong> ${usedGroups}개</p>
                <p><strong>미분류 카드:</strong> ${unassignedCards}개</p>
            `;
            
            document.getElementById('completion-modal').classList.add('show');
        }

        // 소팅 리셋
        function resetSorting() {
            if (confirm('현재 분류를 초기화하시겠습니까?')) {
                participantData.sortingResult = {};
                studyData.groups.forEach(group => {
                    participantData.sortingResult[group] = [];
                });
                renderSortingInterface();
                updateProgress();
                showToast('분류가 초기화되었습니다');
            }
        }

        // 전체 리셋
        function resetAll() {
            if (confirm('모든 설정을 초기화하시겠습니까?')) {
                studyData.cards = [];
                studyData.groups = [];
                renderResearcherMode();
                document.getElementById('url-generator').style.display = 'none';
                showToast('모든 설정이 초기화되었습니다');
            }
        }

        // 결과 다운로드
        function downloadResult() {
            const resultData = {
                participant_id: participantData.name,
                study_title: studyData.title,
                start_time: participantData.startTime,
                end_time: participantData.endTime,
                duration_minutes: Math.round((new Date(participantData.endTime) - new Date(participantData.startTime)) / 60000),
                groups: []
            };
            
            Object.keys(participantData.sortingResult).forEach(groupName => {
                if (participantData.sortingResult[groupName].length > 0) {
                    resultData.groups.push({
                        group_name: groupName,
                        cards: [...participantData.sortingResult[groupName]]
                    });
                }
            });
            
            const blob = new Blob([JSON.stringify(resultData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `card_sorting_${participantData.name}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('결과 파일이 다운로드되었습니다');
        }

        // 이메일 전송 (시뮬레이션)
        function emailResult() {
            const resultData = {
                participant_id: participantData.name,
                study_title: studyData.title,
                groups: []
            };
            
            Object.keys(participantData.sortingResult).forEach(groupName => {
                if (participantData.sortingResult[groupName].length > 0) {
                    resultData.groups.push({
                        group_name: groupName,
                        cards: [...participantData.sortingResult[groupName]]
                    });
                }
            });

            const emailBody = `카드 소팅 결과\n\n참여자: ${participantData.name}\n연구: ${studyData.title}\n\n결과:\n${JSON.stringify(resultData, null, 2)}`;
            const mailtoLink = `mailto:researcher@example.com?subject=카드소팅 결과 - ${participantData.name}&body=${encodeURIComponent(emailBody)}`;
            
            window.location.href = mailtoLink;
            showToast('이메일 클라이언트가 열렸습니다');
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('completion-modal').classList.remove('show');
        }

        // 토스트 메시지
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Enter 키 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('card-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addCard();
            });
            
            document.getElementById('group-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addGroup();
            });

            document.getElementById('base-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') updateBaseURL();
            });

            document.getElementById('participant-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startSorting();
            });
        });

        // 페이지 로드 시 초기화
        window.onload = function() {
            init();
            
            // URL에 연구 데이터가 있으면 참여자 모드로 전환
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('study')) {
                switchMode('participant');
            }
        };
    </script>
</body>
</html>