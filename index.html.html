<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë“œ ì†ŒíŒ… ë¦¬ì„œì¹˜ íˆ´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .mode-selector {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .mode-btn {
            flex: 1;
            padding: 25px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
            margin-bottom: -3px;
        }

        .mode-btn:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        /* ì—°êµ¬ì ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .researcher-mode {
            display: none;
        }

        .researcher-mode.active {
            display: block;
        }

        .setup-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: #f8f9fa;
        }

        .setup-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
        }

        .items-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .item-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .item-tag .remove-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .url-generator {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .url-display {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #2196f3;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }

        /* ì°¸ì—¬ì ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .participant-mode {
            display: none;
        }

        .participant-mode.active {
            display: block;
        }

        .study-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .study-info h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .participant-input {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .sorting-area {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 30px;
            height: 70vh;
        }

        .groups-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 3px dashed #dee2e6;
        }

        .groups-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .group-box {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
            min-height: 120px;
            transition: all 0.3s ease;
        }

        .group-box.drag-over {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: scale(1.02);
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .group-name {
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        .group-name.editable {
            background: none;
            border: none;
            outline: none;
            border-bottom: 2px solid #4facfe;
            padding: 2px 5px;
        }

        .add-group-btn {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-group-btn:hover {
            transform: translateY(-2px);
        }

        .group-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .cards-container {
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            border: 3px dashed #ffc107;
        }

        .cards-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #856404;
            margin-bottom: 20px;
            text-align: center;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .card-item {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            cursor: grab;
            user-select: none;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .card-item:active {
            cursor: grabbing;
        }

        .card-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .card-item.in-group {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            font-size: 0.9em;
            padding: 8px 12px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .completion-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
        }

        .modal-content h3 {
            color: #28a745;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .result-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #dc3545;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .mode-btn {
                padding: 15px 10px;
                font-size: 1em;
            }

            .content {
                padding: 20px;
            }

            .sorting-area {
                height: auto;
            }

            .groups-grid {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§© ì¹´ë“œ ì†ŒíŒ… ë¦¬ì„œì¹˜ íˆ´</h1>
            <p>ì—°êµ¬ìì™€ ì°¸ì—¬ì ëª¨ë‘ë¥¼ ìœ„í•œ ì „ë¬¸ ì¹´ë“œ ì†ŒíŒ… ë„êµ¬</p>
        </div>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('researcher')">ğŸ‘¨â€ğŸ”¬ ì—°êµ¬ì ëª¨ë“œ</button>
            <button class="mode-btn" onclick="switchMode('participant')">ğŸ‘¥ ì°¸ì—¬ì ëª¨ë“œ</button>
        </div>

        <!-- ì—°êµ¬ì ëª¨ë“œ -->
        <div id="researcher-mode" class="content researcher-mode active">
            <div class="setup-section">
                <h3>ğŸ“‹ ì—°êµ¬ ê¸°ë³¸ ì •ë³´</h3>
                <div class="input-group">
                    <input type="text" id="study-title" placeholder="ì—°êµ¬ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="ì‡¼í•‘ëª° ì¹´í…Œê³ ë¦¬ êµ¬ì¡° ìµœì í™” ì—°êµ¬">
                </div>
                <div class="input-group">
                    <input type="text" id="study-description" placeholder="ì—°êµ¬ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value="ì‚¬ìš©ìê°€ ì¸ì‹í•˜ëŠ” ìƒí’ˆ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë°©ì‹ì„ ì•Œì•„ë³´ëŠ” ì—°êµ¬ì…ë‹ˆë‹¤.">
                </div>
            </div>

            <div class="setup-section">
                <h3>ğŸ´ ì¹´ë“œ ì„¤ì • (ìµœëŒ€ 100ê°œ)</h3>
                <div class="input-group">
                    <input type="text" id="card-input" placeholder="ì¹´ë“œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="50">
                    <button class="btn btn-primary" onclick="addCard()">ì¹´ë“œ ì¶”ê°€</button>
                </div>
                <div class="items-list" id="cards-list"></div>
            </div>

            <div class="setup-section">
                <h3>ğŸ“ ê¸°ë³¸ ê·¸ë£¹ ì„¤ì • (ìµœëŒ€ 30ê°œ) - ì„ íƒì‚¬í•­</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">ì˜¤í”ˆ ì¹´ë“œì†ŒíŒ…ì˜ ê²½ìš° ë¹„ì›Œë‘ì„¸ìš”. ì°¸ì—¬ìê°€ ì§ì ‘ ê·¸ë£¹ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="input-group">
                    <input type="text" id="group-input" placeholder="ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="30">
                    <button class="btn btn-primary" onclick="addGroup()">ê·¸ë£¹ ì¶”ê°€</button>
                </div>
                <div class="items-list" id="groups-list"></div>
            </div>

            <div class="setup-section">
                <h3>ğŸŒ ë°°í¬ URL ì„¤ì •</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">Netlify ë°°í¬ í›„ ì‹¤ì œ ë„ë©”ì¸ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://my-card-sorting.netlify.app)</p>
                <div class="input-group">
                    <input type="text" id="base-url" placeholder="https://your-site.netlify.app" value="https://your-site.netlify.app">
                    <button class="btn btn-primary" onclick="updateBaseURL()">URL ì €ì¥</button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success btn-large" onclick="generateStudyURL()">ğŸ”— ì°¸ì—¬ì URL ìƒì„±</button>
                <button class="btn btn-primary btn-large" onclick="downloadHTMLFile()">ğŸ’¾ HTML íŒŒì¼ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-danger btn-large" onclick="resetAll()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
            </div>

            <div class="url-generator" id="url-generator" style="display: none;">
                <h4>ğŸ“¤ ì°¸ì—¬ì ê³µìœ  URL</h4>
                <p>ì•„ë˜ URLì„ ì°¸ì—¬ìë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”:</p>
                <div class="url-display" id="study-url"></div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="copyURL()">ğŸ“‹ URL ë³µì‚¬</button>
                    <button class="btn btn-success" onclick="testParticipantMode()">ğŸ‘¤ ì°¸ì—¬ì í™”ë©´ í…ŒìŠ¤íŠ¸</button>
                </div>
            </div>
        </div>

        <!-- ì°¸ì—¬ì ëª¨ë“œ -->
        <div id="participant-mode" class="content participant-mode">
            <div class="study-info">
                <h3 id="display-study-title">ì¹´ë“œ ì†ŒíŒ… ì—°êµ¬ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤</h3>
                <p id="display-study-description">ì•„ë˜ ì„¤ëª…ì„ ì½ê³  ì¹´ë“œë¥¼ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.</p>
            </div>

            <div class="participant-input">
                <h4>ğŸ‘¤ ì°¸ì—¬ì ì •ë³´</h4>
                <div class="input-group">
                    <input type="text" id="participant-name" placeholder="ì´ë¦„ ë˜ëŠ” ì°¸ì—¬ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button class="btn btn-primary" onclick="startSorting()">ì‹œì‘í•˜ê¸°</button>
                </div>
            </div>

            <div id="sorting-interface" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <p style="text-align: center; margin-bottom: 20px;">
                    ì§„í–‰ë¥ : <span id="progress-text">0%</span> 
                    (<span id="assigned-count">0</span>/<span id="total-count">0</span> ì¹´ë“œ ë¶„ë¥˜ ì™„ë£Œ)
                </p>

                <div class="sorting-area">
                    <div class="groups-container">
                        <div class="groups-title">ğŸ“ ê·¸ë£¹ ì˜ì—­ (ì¹´ë“œë¥¼ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”)</div>
                        <div class="groups-grid" id="groups-grid"></div>
                    </div>

                    <div class="cards-container">
                        <div class="cards-title">ğŸ´ ì¹´ë“œ ëª©ë¡</div>
                        <div class="cards-grid" id="cards-grid"></div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success btn-large" onclick="submitSorting()">âœ… ë¶„ë¥˜ ì™„ë£Œ</button>
                    <button class="btn btn-danger btn-large" onclick="resetSorting()">ğŸ”„ ë‹¤ì‹œ ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì™„ë£Œ ëª¨ë‹¬ -->
    <div class="completion-modal" id="completion-modal">
        <div class="modal-content">
            <h3>ğŸ‰ ë¶„ë¥˜ ì™„ë£Œ!</h3>
            <p>ì¹´ë“œ ì†ŒíŒ…ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
            <div class="result-summary" id="final-summary"></div>
            <div class="action-buttons">
                <button class="btn btn-primary btn-large" onclick="downloadResult()">ğŸ’¾ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-success btn-large" onclick="emailResult()">ğŸ“§ ì´ë©”ì¼ ì „ì†¡</button>
            </div>
            <button class="btn btn-danger" onclick="closeModal()" style="margin-top: 20px;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let studyData = {
            title: '',
            description: '',
            cards: [],
            groups: [],
            isOpenSorting: true
        };
        
        let participantData = {
            name: '',
            startTime: null,
            endTime: null,
            sortingResult: {}
        };

        let baseURL = 'https://your-site.netlify.app'; // ê¸°ë³¸ URL

        // ì´ˆê¸°í™”
        function init() {
            loadSampleData();
            renderResearcherMode();
        }

        // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ
        function loadSampleData() {
            studyData.cards = ['ìŠ¤ë§ˆíŠ¸í°', 'ë…¸íŠ¸ë¶', 'íƒœë¸”ë¦¿', 'ëƒ‰ì¥ê³ ', 'ì„¸íƒê¸°', 'ì „ìë ˆì¸ì§€', 'ë¸”ë¼ìš°ìŠ¤', 'ì²­ë°”ì§€', 'ìš´ë™í™”'];
            studyData.groups = ['ì „ìê¸°ê¸°', 'ê°€ì „ì œí’ˆ', 'ì˜ë¥˜'];
            studyData.title = 'ì‡¼í•‘ëª° ì¹´í…Œê³ ë¦¬ êµ¬ì¡° ìµœì í™” ì—°êµ¬';
            studyData.description = 'ì‚¬ìš©ìê°€ ì¸ì‹í•˜ëŠ” ìƒí’ˆ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë°©ì‹ì„ ì•Œì•„ë³´ëŠ” ì—°êµ¬ì…ë‹ˆë‹¤.';
        }

        // ëª¨ë“œ ì „í™˜
        function switchMode(mode) {
            // ëª¨ë“  ëª¨ë“œ ë¹„í™œì„±í™”
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.researcher-mode, .participant-mode').forEach(content => content.classList.remove('active'));
            
            // ì„ íƒëœ ëª¨ë“œ í™œì„±í™”
            event.target.classList.add('active');
            document.getElementById(mode + '-mode').classList.add('active');

            if (mode === 'researcher') {
                renderResearcherMode();
            } else {
                renderParticipantMode();
            }
        }

        // ì—°êµ¬ì ëª¨ë“œ ë Œë”ë§
        function renderResearcherMode() {
            document.getElementById('study-title').value = studyData.title;
            document.getElementById('study-description').value = studyData.description;
            document.getElementById('base-url').value = baseURL;
            renderCardsList();
            renderGroupsList();
        }

        function renderCardsList() {
            const cardsList = document.getElementById('cards-list');
            cardsList.innerHTML = '';
            studyData.cards.forEach((card, index) => {
                cardsList.innerHTML += `
                    <div class="item-tag">
                        ${card}
                        <button class="remove-btn" onclick="removeCard(${index})">Ã—</button>
                    </div>
                `;
            });
        }

        function renderGroupsList() {
            const groupsList = document.getElementById('groups-list');
            groupsList.innerHTML = '';
            studyData.groups.forEach((group, index) => {
                groupsList.innerHTML += `
                    <div class="item-tag">
                        ${group}
                        <button class="remove-btn" onclick="removeGroup(${index})">Ã—</button>
                    </div>
                `;
            });
        }

        // ì¹´ë“œ ì¶”ê°€
        function addCard() {
            const input = document.getElementById('card-input');
            const cardText = input.value.trim();
            
            if (!cardText) {
                showToast('ì¹´ë“œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            if (studyData.cards.length >= 100) {
                showToast('ì¹´ë“œëŠ” ìµœëŒ€ 100ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (studyData.cards.includes(cardText)) {
                showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´ë“œì…ë‹ˆë‹¤', 'error');
                return;
            }
            
            studyData.cards.push(cardText);
            input.value = '';
            renderCardsList();
            showToast('ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // ê·¸ë£¹ ì¶”ê°€
        function addGroup() {
            const input = document.getElementById('group-input');
            const groupText = input.value.trim();
            
            if (!groupText) {
                showToast('ê·¸ë£¹ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            if (studyData.groups.length >= 30) {
                showToast('ê·¸ë£¹ì€ ìµœëŒ€ 30ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            if (studyData.groups.includes(groupText)) {
                showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·¸ë£¹ì…ë‹ˆë‹¤', 'error');
                return;
            }
            
            studyData.groups.push(groupText);
            input.value = '';
            renderGroupsList();
            showToast('ê·¸ë£¹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // ì¹´ë“œ/ê·¸ë£¹ ì œê±°
        function removeCard(index) {
            studyData.cards.splice(index, 1);
            renderCardsList();
            showToast('ì¹´ë“œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        function removeGroup(index) {
            studyData.groups.splice(index, 1);
            renderGroupsList();
            showToast('ê·¸ë£¹ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // HTML íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadHTMLFile() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'card-sorting-tool.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('HTML íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ë² ì´ìŠ¤ URL ì—…ë°ì´íŠ¸
        function updateBaseURL() {
            const urlInput = document.getElementById('base-url').value.trim();
            if (urlInput) {
                baseURL = urlInput.endsWith('/') ? urlInput.slice(0, -1) : urlInput;
                showToast('ë°°í¬ URLì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            } else {
                showToast('ì˜¬ë°”ë¥¸ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
            }
        }

        // URL ìƒì„±
        function generateStudyURL() {
            if (studyData.cards.length === 0) {
                showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¹´ë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            // ì—°êµ¬ ì •ë³´ ì—…ë°ì´íŠ¸
            studyData.title = document.getElementById('study-title').value.trim() || 'ì¹´ë“œ ì†ŒíŒ… ì—°êµ¬';
            studyData.description = document.getElementById('study-description').value.trim() || 'ì¹´ë“œë¥¼ ì ì ˆí•œ ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.';
            studyData.isOpenSorting = studyData.groups.length === 0;

            // URL ë§¤ê°œë³€ìˆ˜ë¡œ ë°ì´í„° ì¸ì½”ë”©
            const encodedData = btoa(encodeURIComponent(JSON.stringify(studyData)));
            
            // ì‹¤ì œ ë°°í¬ URL ì‚¬ìš©
            let finalURL = baseURL;
            
            // í˜„ì¬ í™˜ê²½ì´ ì‹¤ì œ ì›¹ì‚¬ì´íŠ¸ì¸ì§€ í™•ì¸
            const currentLocation = window.location.href;
            if (!currentLocation.includes('about:srcdoc') && !currentLocation.includes('localhost')) {
                finalURL = currentLocation.split('?')[0];
            }
            
            const studyURL = `${finalURL}?study=${encodedData}`;
            
            document.getElementById('study-url').textContent = studyURL;
            document.getElementById('url-generator').style.display = 'block';
            showToast('ì°¸ì—¬ì URLì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // URL ë³µì‚¬
        function copyURL() {
            const urlText = document.getElementById('study-url').textContent;
            navigator.clipboard.writeText(urlText).then(() => {
                showToast('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
            }).catch(() => {
                showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            });
        }

        // ì°¸ì—¬ì í™”ë©´ í…ŒìŠ¤íŠ¸
        function testParticipantMode() {
            switchMode('participant');
            loadStudyFromURL();
        }

        // ì°¸ì—¬ì ëª¨ë“œ ë Œë”ë§
        function renderParticipantMode() {
            // URLì—ì„œ ì—°êµ¬ ë°ì´í„° ë¡œë“œ
            loadStudyFromURL();
            
            document.getElementById('display-study-title').textContent = studyData.title;
            document.getElementById('display-study-description').textContent = studyData.description;
        }

        // URLì—ì„œ ì—°êµ¬ ë°ì´í„° ë¡œë“œ
        function loadStudyFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const studyParam = urlParams.get('study');
            
            if (studyParam) {
                try {
                    const decodedData = JSON.parse(decodeURIComponent(atob(studyParam)));
                    studyData = decodedData;
                    document.getElementById('display-study-title').textContent = studyData.title;
                    document.getElementById('display-study-description').textContent = studyData.description;
                } catch (error) {
                    showToast('ì—°êµ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
        }

        // ì¹´ë“œ ì†ŒíŒ… ì‹œì‘
        function startSorting() {
            const participantName = document.getElementById('participant-name').value.trim();
            
            if (!participantName) {
                showToast('ì°¸ì—¬ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            participantData.name = participantName;
            participantData.startTime = new Date().toISOString();
            participantData.sortingResult = {};

            // ê·¸ë£¹ ì´ˆê¸°í™”
            studyData.groups.forEach(group => {
                participantData.sortingResult[group] = [];
            });

            document.getElementById('sorting-interface').style.display = 'block';
            renderSortingInterface();
            updateProgress();
            showToast('ì¹´ë“œ ì†ŒíŒ…ì„ ì‹œì‘í•©ë‹ˆë‹¤!');
        }

        // ì†ŒíŒ… ì¸í„°í˜ì´ìŠ¤ ë Œë”ë§
        function renderSortingInterface() {
            renderGroupsGrid();
            renderCardsGrid();
        }

        function renderGroupsGrid() {
            const groupsGrid = document.getElementById('groups-grid');
            groupsGrid.innerHTML = '';
            
            // ê¸°ì¡´ ê·¸ë£¹ë“¤
            studyData.groups.forEach((group, index) => {
                groupsGrid.innerHTML += `
                    <div class="group-box" data-group="${group}" ondragover="allowDrop(event)" ondrop="dropCard(event)">
                        <div class="group-header">
                            <div class="group-name">${group}</div>
                        </div>
                        <div class="group-cards" id="group-${group.replace(/\s+/g, '-')}"></div>
                    </div>
                `;
            });
            
            // ì˜¤í”ˆ ì†ŒíŒ…ì¸ ê²½ìš° ìƒˆ ê·¸ë£¹ ì¶”ê°€ ë²„íŠ¼
            if (studyData.isOpenSorting) {
                groupsGrid.innerHTML += `
                    <div class="add-group-btn" onclick="addNewGroup()">
                        â• ìƒˆ ê·¸ë£¹ ì¶”ê°€
                    </div>
                `;
            }
        }

        function renderCardsGrid() {
            const cardsGrid = document.getElementById('cards-grid');
            cardsGrid.innerHTML = '';
            
            studyData.cards.forEach((card, index) => {
                const isAssigned = Object.values(participantData.sortingResult).some(groupCards => groupCards.includes(card));
                if (!isAssigned) {
                    cardsGrid.innerHTML += `
                        <div class="card-item" draggable="true" ondragstart="dragStart(event)" data-card="${card}">
                            ${card}
                        </div>
                    `;
                }
            });
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        function dragStart(event) {
            event.dataTransfer.setData('text/plain', event.target.dataset.card);
            event.target.classList.add('dragging');
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function dropCard(event) {
            event.preventDefault();
            const card = event.dataTransfer.getData('text/plain');
            const groupBox = event.currentTarget;
            const groupName = groupBox.dataset.group;
            
            groupBox.classList.remove('drag-over');
            
            // ì¹´ë“œë¥¼ ê·¸ë£¹ì— ì¶”ê°€
            if (!participantData.sortingResult[groupName]) {
                participantData.sortingResult[groupName] = [];
            }
            
            // ë‹¤ë¥¸ ê·¸ë£¹ì—ì„œ ì¹´ë“œ ì œê±°
            Object.keys(participantData.sortingResult).forEach(group => {
                participantData.sortingResult[group] = participantData.sortingResult[group].filter(c => c !== card);
            });
            
            participantData.sortingResult[groupName].push(card);
            
            // UI ì—…ë°ì´íŠ¸
            updateGroupDisplay(groupName);
            renderCardsGrid();
            updateProgress();
            
            // ë“œë˜ê·¸ íš¨ê³¼ ì œê±°
            document.querySelectorAll('.card-item').forEach(cardEl => {
                cardEl.classList.remove('dragging');
            });
        }

        function updateGroupDisplay(groupName) {
            const groupCardsContainer = document.getElementById(`group-${groupName.replace(/\s+/g, '-')}`);
            if (groupCardsContainer) {
                groupCardsContainer.innerHTML = '';
                participantData.sortingResult[groupName].forEach(card => {
                    groupCardsContainer.innerHTML += `
                        <div class="card-item in-group" onclick="removeFromGroup('${card}', '${groupName}')">
                            ${card}
                        </div>
                    `;
                });
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            const totalCards = studyData.cards.length;
            const assignedCards = Object.values(participantData.sortingResult).reduce((sum, groupCards) => sum + groupCards.length, 0);
            const progress = Math.round((assignedCards / totalCards) * 100);
            
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = progress + '%';
            document.getElementById('assigned-count').textContent = assignedCards;
            document.getElementById('total-count').textContent = totalCards;
        }

        // ê·¸ë£¹ì—ì„œ ì¹´ë“œ ì œê±°
        function removeFromGroup(card, groupName) {
            participantData.sortingResult[groupName] = participantData.sortingResult[groupName].filter(c => c !== card);
            updateGroupDisplay(groupName);
            renderCardsGrid();
            updateProgress();
        }

        // ìƒˆ ê·¸ë£¹ ì¶”ê°€ (ì˜¤í”ˆ ì†ŒíŒ…)
        function addNewGroup() {
            const groupName = prompt('ìƒˆ ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (groupName && groupName.trim()) {
                const trimmedName = groupName.trim();
                if (!Object.keys(participantData.sortingResult).includes(trimmedName)) {
                    participantData.sortingResult[trimmedName] = [];
                    studyData.groups.push(trimmedName);
                    renderGroupsGrid();
                    showToast('ìƒˆ ê·¸ë£¹ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
                } else {
                    showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·¸ë£¹ëª…ì…ë‹ˆë‹¤', 'error');
                }
            }
        }

        // ì†ŒíŒ… ì œì¶œ
        function submitSorting() {
            const assignedCards = Object.values(participantData.sortingResult).reduce((sum, groupCards) => sum + groupCards.length, 0);
            
            if (assignedCards === 0) {
                showToast('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¹´ë“œë¥¼ ë¶„ë¥˜í•´ì£¼ì„¸ìš”', 'error');
                return;
            }

            participantData.endTime = new Date().toISOString();
            
            // ê²°ê³¼ ìš”ì•½
            const totalCards = studyData.cards.length;
            const usedGroups = Object.keys(participantData.sortingResult).filter(group => participantData.sortingResult[group].length > 0).length;
            const unassignedCards = totalCards - assignedCards;
            
            document.getElementById('final-summary').innerHTML = `
                <p><strong>ì´ ì¹´ë“œ ìˆ˜:</strong> ${totalCards}ê°œ</p>
                <p><strong>ë¶„ë¥˜ ì™„ë£Œ:</strong> ${assignedCards}ê°œ</p>
                <p><strong>ì‚¬ìš©ëœ ê·¸ë£¹:</strong> ${usedGroups}ê°œ</p>
                <p><strong>ë¯¸ë¶„ë¥˜ ì¹´ë“œ:</strong> ${unassignedCards}ê°œ</p>
            `;
            
            document.getElementById('completion-modal').classList.add('show');
        }

        // ì†ŒíŒ… ë¦¬ì…‹
        function resetSorting() {
            if (confirm('í˜„ì¬ ë¶„ë¥˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                participantData.sortingResult = {};
                studyData.groups.forEach(group => {
                    participantData.sortingResult[group] = [];
                });
                renderSortingInterface();
                updateProgress();
                showToast('ë¶„ë¥˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }

        // ì „ì²´ ë¦¬ì…‹
        function resetAll() {
            if (confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                studyData.cards = [];
                studyData.groups = [];
                renderResearcherMode();
                document.getElementById('url-generator').style.display = 'none';
                showToast('ëª¨ë“  ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        }

        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        function downloadResult() {
            const resultData = {
                participant_id: participantData.name,
                study_title: studyData.title,
                start_time: participantData.startTime,
                end_time: participantData.endTime,
                duration_minutes: Math.round((new Date(participantData.endTime) - new Date(participantData.startTime)) / 60000),
                groups: []
            };
            
            Object.keys(participantData.sortingResult).forEach(groupName => {
                if (participantData.sortingResult[groupName].length > 0) {
                    resultData.groups.push({
                        group_name: groupName,
                        cards: [...participantData.sortingResult[groupName]]
                    });
                }
            });
            
            const blob = new Blob([JSON.stringify(resultData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `card_sorting_${participantData.name}_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('ê²°ê³¼ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        // ì´ë©”ì¼ ì „ì†¡ (ì‹œë®¬ë ˆì´ì…˜)
        function emailResult() {
            const resultData = {
                participant_id: participantData.name,
                study_title: studyData.title,
                groups: []
            };
            
            Object.keys(participantData.sortingResult).forEach(groupName => {
                if (participantData.sortingResult[groupName].length > 0) {
                    resultData.groups.push({
                        group_name: groupName,
                        cards: [...participantData.sortingResult[groupName]]
                    });
                }
            });

            const emailBody = `ì¹´ë“œ ì†ŒíŒ… ê²°ê³¼\n\nì°¸ì—¬ì: ${participantData.name}\nì—°êµ¬: ${studyData.title}\n\nê²°ê³¼:\n${JSON.stringify(resultData, null, 2)}`;
            const mailtoLink = `mailto:researcher@example.com?subject=ì¹´ë“œì†ŒíŒ… ê²°ê³¼ - ${participantData.name}&body=${encodeURIComponent(emailBody)}`;
            
            window.location.href = mailtoLink;
            showToast('ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('completion-modal').classList.remove('show');
        }

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Enter í‚¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('card-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addCard();
            });
            
            document.getElementById('group-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addGroup();
            });

            document.getElementById('base-url').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') updateBaseURL();
            });

            document.getElementById('participant-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') startSorting();
            });
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            init();
            
            // URLì— ì—°êµ¬ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì°¸ì—¬ì ëª¨ë“œë¡œ ì „í™˜
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('study')) {
                switchMode('participant');
            }
        };
    </script>
</body>
</html>